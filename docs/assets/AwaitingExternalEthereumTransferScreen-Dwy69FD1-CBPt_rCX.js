import{aR as qe,a2 as De,aQ as Re,a3 as _e,c as ne,h as re,M as Le,aO as H,j as d}from"./vendor-wallet-iWeBopzN.js";import{F as Qe}from"./CheckCircleIcon-DANTQeuo.js";import{r}from"./vendor-react-NLnOsXgy.js";import{c as Oe,n as Ye,s as Ze}from"./Layouts-BlFm53ED-SRVhpBUn.js";import{u as ie}from"./ModalHeader-D8-mhjp4-idcyyJVk.js";import{o as Ve}from"./ScreenHeader-CHmc4-Lu-BWVzMndk.js";import{t as se}from"./FundWalletMethodHeader-Cfci4-83-BtzElGDm.js";import{t as Je}from"./index-Dq_xe9dz-Bi_UR9Ar.js";import{I as Ke,a as ze,r as Ge,n as Xe,O as et,l as oe,_ as S,q as A,E as x,N as de,f as tt}from"./index-DOPD16Fz.js";import{c as at,n as nt}from"./useGetTokenPrice-BPBpM07F-DEp1JkYX.js";import{t as ce,a as rt}from"./transfer-6YztDh-t-DU6hH7CZ.js";import{t as it}from"./formatErc20TokenAmount-BuPk9xcy-CkAr4Oc0.js";import{n as st,o as le,c as L,l as ot}from"./ethers-D1WT71Ay-s52whpbP.js";import{t as ue}from"./analytics-mkkvFRju-DOXuftJB.js";import{o as Q,u as me,d as fe,f as dt}from"./reservoir-0wfhnc0j-Dqcbe9w0.js";import{H as ct,Z as lt}from"./BridgeNetworkSelectionView-CaDh-Zck-DMtyJfSK.js";import{n as ut}from"./getErc20Balance-DA4dGV9O-CHa6fqyU.js";import{I as mt}from"./TransferOrBridgeLoadingScreen-DcCdHB-g-DP_ak6Al.js";import"./useGetSolPrice-DwwjjGbd-BJGmHsgY.js";import"./Value-tcJV9e0L-BBxovPuc.js";import"./LoadingSkeleton-U6-3yFwI-DZmZug2U.js";import"./ErrorMessage-D8VaAP5m-DXLnMoFv.js";import"./Subtitle-CV-2yKE4-DVwjrzL4.js";import"./Title-BnzYV3Is-CcF3k3X9.js";import"./WalletIcon-BrbXK2eY.js";import"./getChainName-DjpPdUSc-c2urPd0g.js";import"./Chip-D2-wZOHJ-bLViJ-qQ.js";import"./shared-FM0rljBt-N4c19p5w.js";import"./ChevronDownIcon-Drg772V5.js";import"./styles-BmZHuqSX-DoEYhb_F.js";import"./LinkPasskeyScreen-OxaghvUl-yYheMpOs.js";import"./TodoList-CgrU7uwu-Cr1TVKAZ.js";import"./createLucideIcon-4wkIQryq.js";import"./check-B9ysh8c4.js";import"./ScreenLayout-DTmQLGPf-DHhzTInP.js";import"./Screen-Bp-TN9gb-CKhJalZZ.js";import"./circle-check-big-YWHND4yl.js";import"./fingerprint-pattern-ONAhdVhn.js";import"./formatters-DwTIoOJg.js";import"./InjectedWalletIcon-DLcYOGDj-5VUxgLWA.js";import"./Address-BjZb-TIL-hBpAKg2Y.js";import"./copy-BmDK-JXv.js";import"./GlobeAltIcon-kW1lCngP.js";const aa={component:()=>{let{rpcConfig:j,appId:y,closePrivyModal:he,createAnalyticsEvent:O}=Ke(),{navigate:pe,setModalData:M,data:o}=ze(),Y=Ge(),{wallets:ge}=Xe(),[ve,ye]=r.useState(!1),[C,Ce]=r.useState(0n),[Z,V]=r.useState(!1),[P,g]=r.useState(null),[Ie,W]=r.useState(null),[T,Te]=r.useState([]),[J,we]=r.useState(0),[K,N]=r.useState(!1),[q,B]=r.useState(!1),[z,D]=r.useState(!1),[R,G]=r.useState(!1),[be,Ee]=r.useState(),[Se,X]=r.useState();if(!o?.funding||o.funding.chainType!=="ethereum")throw Error("Invalid funding data");let{erc20ContractInfo:s,chain:t,connectedWallet:ee}=o.funding,h=o.funding.address,m=o.funding.erc20Address,[w,xe]=r.useState(o.funding.amount);r.useEffect((()=>{m&&!s&&g(Error("Unable to fetch token details"))}),[]);let c=!!m&&!!s,f=c?BigInt(parseFloat(w)*10**s.decimals):qe(w),a=(ee?.type==="ethereum"?ee:void 0)??ge[0],Ne=et(a?.walletClientType||"unknown"),te=Ne?.name||"wallet",[v,$e]=r.useState(null);r.useEffect((()=>{(async()=>{if(!a)return;let n=await a.getEthereumProvider();$e(De({account:a.address,transport:Re(n)}).extend(_e))})().catch(console.error)}),[a]);let[Fe,Ae]=r.useState(0n);r.useEffect((()=>{ne({chain:t,transport:re(oe(t,j,y))}).getBalance({address:h}).then(Ae).catch(console.error)}),[]);let[je,Be]=r.useState(0n);r.useEffect((()=>{c&&ut({chain:t,address:h,appId:y,rpcConfig:j,erc20Address:m}).then((n=>Be(n.balance))).catch(console.error)}),[]);let{tokenPrice:b}=at(t.id),[i,U]=r.useState({to:h,chain:t,value:f,data:void 0});r.useEffect((()=>{(async()=>{let n,u;if(!v||!a||K||z)return;N(!0);let I=ne({chain:i.chain,transport:re(oe(i.chain,j,y))});if(c&&!i.data)return await I.simulateContract({address:m,chain:i.chain,abi:ce,functionName:"transfer",args:[h,f],account:a.address}).catch((l=>{if(l?.cause?.name==="ContractFunctionZeroDataError"||l?.message?.includes("returned no data"))return I.simulateContract({address:m,chain:i.chain,abi:rt,functionName:"transfer",args:[h,f],account:a.address}).catch((E=>{console.warn("Simulated token transfer failed with error, fetching bridge options.",E)}));console.warn("Simulated token transfer failed with error, fetching bridge options.",l)}))?(N(!1),void U({to:m,chain:i.chain,data:Le({abi:ce,functionName:"transfer",args:[h,f]}),value:"0x0"})):(N(!1),void V(!0));try{n=await I.prepareTransactionRequest({account:a.address,to:i.to,chain:i.chain,data:i.data,value:BigInt(i.value??0)})}catch(l){if(console.error(l),T.length>1)W(l.shortMessage??"Something went wrong");else if(q&&T.length===0)return void g(new S(`Wallet ${A(a.address)} does not have enough funds.`,void 0,x.INSUFFICIENT_BALANCE))}if(!n)return N(!1),void V(!0);N(!1),D(!0),ye(!0),Ce(n.gas);try{await v.switchChain({id:i.chain.id})}catch{await v.addChain({chain:i.chain}),await v.switchChain({id:i.chain.id})}try{u=await v.sendTransaction(n)}catch(l){if(console.error(l),l.name==="TransactionExecutionError")if(T.length<1){let E=l.shortMessage;(l.shortMessage.includes("rejected the request")||l.details.includes("rejected the request"))&&(E="User rejected the request."),g(new S(E,void 0,x.TRANSACTION_FAILURE))}else W(l.shortMessage??"Something went wrong")}if(u)return await v.waitForTransactionReceipt({hash:u}),D(!1),q?(Ee(u),void X("pending")):(G(!0),M(de(o,"completed",u,a?.walletClientType,c,s,t)),void O({eventName:ue,payload:{provider:"external",status:"success",txHash:u,address:a.address,chainId:i.chain.id,chainType:"ethereum",value:i.value?H(BigInt(i.value),s?.decimals??18):void 0,token:s?.symbol??m??"ETH",destinationAddress:h,destinationChainId:t.id,destinationChainType:"ethereum",destinationValue:f?H(f,s?.decimals??18):void 0,destinationToken:s?.symbol??m??t.nativeCurrency.name}}));D(!1)})().catch(console.error)}),[v,i]),r.useEffect((()=>{(async()=>{if(!Z||!v||!a)return;let n=nt(Y.chains).filter((e=>e.id!==t.id&&!!e.testnet==!!t.testnet));c&&n.unshift(t);let u=await ct({chains:n,address:a.address,appId:y,rpcConfig:j,includeUsdc:o.funding?.isUSDC}),I=c?u.filter((e=>e.balance>0n)):u.filter((e=>e.balance>f)),l=c&&u.every((e=>e.balance===0n));if(I.length<1)return void g(new S(l?`Wallet ${A(a.address)} doesn't have enough funds to cover gas fees. Top up your wallet and try again.`:`Wallet ${A(a.address)} does not have enough funds.`,void 0,x.INSUFFICIENT_BALANCE));I.sort(((e,F)=>Number(c?(F.erc20Balance??0n)-(e.erc20Balance??0n):F.balance-e.balance)));let E=I.flatMap((e=>{let F=[{...e,isErc20Quote:!1,isTestnet:!!t.testnet,input:Q({appId:y,amount:f.toString(),user:a.address,recipient:h,destinationChainId:t.id,destinationCurrency:m,originChainId:e.chain.id})}];return c&&m&&(e.erc20Balance??0n)>=f&&F.push({...e,isErc20Quote:!0,isTestnet:!!t.testnet,input:Q({appId:y,amount:f.toString(),user:a.address,recipient:h,destinationChainId:t.id,destinationCurrency:m,originChainId:e.chain.id,originCurrency:e.erc20Address})}),F})),ae=(await Promise.allSettled(E.map((async e=>({...e,quote:await me(e)}))))).filter((e=>e.status==="fulfilled")).map((e=>e.value));if(ae.length<1)return void g(new S(`Wallet ${A(a.address)} does not have enough funds.`,void 0,x.INSUFFICIENT_BALANCE));let _=ae.map((e=>({bridgeTx:fe(e.quote),balance:e.balance,chain:e.chain,erc20Balance:e.erc20Balance,isErc20Quote:e.isErc20Quote}))).filter((e=>!!e.bridgeTx));if(_.length>1)return void Te(_);let $=_[0];$?(B(!0),U({data:$.bridgeTx.data,to:$.bridgeTx.to,value:$.bridgeTx.value,chain:$.chain})):g(new S(`Wallet ${A(a.address)} does not have enough funds.`,void 0,x.INSUFFICIENT_BALANCE))})().catch(console.error)}),[Z]),dt({transactionHash:be,isTestnet:!!t.testnet,bridgingStatus:Se,setBridgingStatus:X,onSuccess({transactionHash:n}){B(!1),G(!0),M(de(o,"completed",n,a?.walletClientType,c,s,t)),O({eventName:ue,payload:{provider:"external",status:"success",txHash:n,address:a?.address,chainId:i.chain.id,chainType:"ethereum",value:i.value?H(BigInt(i.value),s?.decimals??18):void 0,token:s?.symbol??m??"ETH",destinationAddress:h,destinationChainId:t.id,destinationChainType:"ethereum",destinationValue:f?H(f,s?.decimals??18):void 0,destinationToken:s?.symbol??m??t.nativeCurrency.name}})},onFailure({error:n}){B(!1),g(n)}}),r.useEffect((()=>{P&&(M({funding:o?.funding,solanaFundingData:o?.solanaFundingData,sendTransaction:o?.sendTransaction,errorModalData:{error:P,previousScreen:"TransferFromWalletScreen"}}),pe("ErrorScreen",!1))}),[P]);let Ue=!c&&b?st(w??"0",b):void 0,k=c?C:ot([C,f]),ke=k&&b?le(k,b):void 0,He=k?L(k,o?.funding?.erc20Address?o?.funding?.erc20ContractInfo?.symbol||"ETH":o?.funding?.chain.nativeCurrency.symbol||"ETH"):void 0,Me=C&&b?le(C,b):void 0,Pe=C?L(C,t?.nativeCurrency?.symbol||"ETH"):void 0;if(r.useEffect((()=>{if(!R)return;let n=setTimeout(he,tt);return()=>clearTimeout(n)}),[R]),R)return d.jsxs(d.Fragment,{children:[d.jsx(se,{}),d.jsx(Oe,{}),d.jsxs(Ye,{children:[d.jsx(Qe,{color:"var(--privy-color-success)",width:"64px",height:"64px"}),d.jsx(Ve,{title:"Success!",description:`Youâ€™ve successfully added ${w} ${c?s.symbol:t.nativeCurrency.symbol} to your ${Y.name} wallet. It may take a minute before the funds are available to use.`})]}),d.jsx(Ze,{}),d.jsx(ie,{})]});let We=c?`${it({amount:je,decimals:s.decimals})}  ${s.symbol}`:L(Fe,t.nativeCurrency.symbol,3,!0),p=T[J];return T.length>1&&p?d.jsx(lt,{displayName:te,configuredFundingChain:t,erc20ContractInfo:s,formattedBalance:We,fundingAmount:w,fundingCurrency:c?s.symbol:t.nativeCurrency.symbol,fundingAmountInUsd:Ue,options:T,selectedOption:p,isPreparing:K,isSubmitting:z,addressToFund:h,fundingWalletAddress:a?.address||"",errorMessage:Ie,onSubmit:()=>{o.funding?.amount!==w?(async function(){if(a&&p)try{let n=await me({isTestnet:!!t.testnet,input:Q({appId:y,amount:f.toString(),user:a.address,recipient:h,destinationChainId:t.id,destinationCurrency:m,originChainId:p.chain.id})}),u=fe(n);if(!u)throw Error("Invalid transaction request");B(!0),U({data:u.data,to:u.to,value:u.value,chain:p.chain})}catch(n){console.error(n),g(new S("Unable to fetch quotes for bridging",n,x.INSUFFICIENT_BALANCE))}})().catch(console.error):U({to:p.bridgeTx.to,data:p.bridgeTx.data,value:p.bridgeTx.value,chain:p.chain})},onSelect:n=>{n!==J&&(W(null),we(n))},onAmountChange:xe}):ve&&C&&a&&o?.funding?d.jsx(mt,{walletClientType:a?.walletClientType||"unknown",displayName:te,addressToFund:h,isBridging:q,isErc20Flow:c,totalPriceInUsd:ke,totalPriceInNativeCurrency:He,gasPriceInUsd:Me,gasPriceInNativeCurrency:Pe,chainId:t.id,chainName:t.name}):d.jsxs(d.Fragment,{children:[d.jsx(se,{}),d.jsx(Je,{}),d.jsx("div",{style:{marginTop:"1rem"}}),d.jsx(ie,{})]})}};export{aa as AwaitingExternalEthereumTransferScreen,aa as default};
