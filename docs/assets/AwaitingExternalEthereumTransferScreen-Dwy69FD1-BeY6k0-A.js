import{aQ as qe,a2 as De,aP as _e,a3 as Le,c as ne,h as re,M as Re,aN as P,j as d}from"./vendor-wallet-F4boqawy.js";import{F as Qe}from"./CheckCircleIcon-BVC7gvnW.js";import{r}from"./vendor-react-BtAbuqlL.js";import{c as Oe,n as Ye,s as Ze}from"./Layouts-BlFm53ED-B0zF6zd2.js";import{u as ie}from"./ModalHeader-D8-mhjp4-BslQ1U_D.js";import{o as Ve}from"./ScreenHeader-CHmc4-Lu-D1bYlEBx.js";import{t as se}from"./FundWalletMethodHeader-Cfci4-83-BP__VZ_b.js";import{t as Je}from"./index-Dq_xe9dz-B-ZuR1jG.js";import{I as Ke,a as ze,r as Ge,n as Xe,O as et,l as oe,_ as S,q as A,E as x,N as de,f as tt}from"./index-D4_bkFqi.js";import{c as at,n as nt}from"./useGetTokenPrice-BPBpM07F-QeQiuQK6.js";import{t as ce,a as rt}from"./transfer-6YztDh-t-DU6hH7CZ.js";import{t as it}from"./formatErc20TokenAmount-BuPk9xcy-CkAr4Oc0.js";import{n as st,o as le,c as R,l as ot}from"./ethers-D1WT71Ay-4Kms-8MX.js";import{t as ue}from"./analytics-mkkvFRju-DOXuftJB.js";import{o as Q,u as me,d as fe,f as dt}from"./reservoir-0wfhnc0j-D6klyHgP.js";import{H as ct,Z as lt}from"./BridgeNetworkSelectionView-CaDh-Zck-CxZvh10C.js";import{n as ut}from"./getErc20Balance-DA4dGV9O-DZMbHVZ5.js";import{I as mt}from"./TransferOrBridgeLoadingScreen-DcCdHB-g-Bwty2e6W.js";import"./useGetSolPrice-DwwjjGbd-nhi0LPbb.js";import"./Value-tcJV9e0L-Cj9z5UJ0.js";import"./LoadingSkeleton-U6-3yFwI-Bohjobfm.js";import"./ErrorMessage-D8VaAP5m-BW99Muke.js";import"./Subtitle-CV-2yKE4-CUXxroTu.js";import"./Title-BnzYV3Is-BH5k9HNP.js";import"./WalletIcon-CnVXn2D1.js";import"./getChainName-DjpPdUSc-c2urPd0g.js";import"./Chip-D2-wZOHJ-CgL5fvIQ.js";import"./shared-FM0rljBt-CfAQ1LFd.js";import"./ChevronDownIcon-CrOO2JkX.js";import"./styles-BmZHuqSX-CksJEmmA.js";import"./LinkPasskeyScreen-OxaghvUl-D-dpUc0-.js";import"./TodoList-CgrU7uwu-DoaRAZ2-.js";import"./createLucideIcon-BYAZb6Ze.js";import"./check-BijN9Qmp.js";import"./ScreenLayout-DTmQLGPf-C5KWh9uZ.js";import"./Screen-Bp-TN9gb-CFVrYp49.js";import"./circle-check-big-CyPDT8oi.js";import"./fingerprint-pattern-BagXuUZ5.js";import"./formatters-BCFvnnkN.js";import"./InjectedWalletIcon-DLcYOGDj-BjcTpqD3.js";import"./Address-BjZb-TIL-crS8tAmh.js";import"./copy-BdFFznhB.js";import"./GlobeAltIcon-NZtGBBrJ.js";const aa={component:()=>{let{rpcConfig:j,appId:y,closePrivyModal:he,createAnalyticsEvent:O}=Ke(),{navigate:pe,setModalData:H,data:o}=ze(),Y=Ge(),{wallets:ge}=Xe(),[ve,ye]=r.useState(!1),[C,Ce]=r.useState(0n),[Z,V]=r.useState(!1),[M,g]=r.useState(null),[Ie,W]=r.useState(null),[T,Te]=r.useState([]),[J,we]=r.useState(0),[K,N]=r.useState(!1),[q,B]=r.useState(!1),[z,D]=r.useState(!1),[_,G]=r.useState(!1),[be,Ee]=r.useState(),[Se,X]=r.useState();if(!o?.funding||o.funding.chainType!=="ethereum")throw Error("Invalid funding data");let{erc20ContractInfo:s,chain:t,connectedWallet:ee}=o.funding,h=o.funding.address,m=o.funding.erc20Address,[w,xe]=r.useState(o.funding.amount);r.useEffect((()=>{m&&!s&&g(Error("Unable to fetch token details"))}),[]);let c=!!m&&!!s,f=c?BigInt(parseFloat(w)*10**s.decimals):qe(w),a=(ee?.type==="ethereum"?ee:void 0)??ge[0],Ne=et(a?.walletClientType||"unknown"),te=Ne?.name||"wallet",[v,$e]=r.useState(null);r.useEffect((()=>{(async()=>{if(!a)return;let n=await a.getEthereumProvider();$e(De({account:a.address,transport:_e(n)}).extend(Le))})().catch(console.error)}),[a]);let[Fe,Ae]=r.useState(0n);r.useEffect((()=>{ne({chain:t,transport:re(oe(t,j,y))}).getBalance({address:h}).then(Ae).catch(console.error)}),[]);let[je,Be]=r.useState(0n);r.useEffect((()=>{c&&ut({chain:t,address:h,appId:y,rpcConfig:j,erc20Address:m}).then((n=>Be(n.balance))).catch(console.error)}),[]);let{tokenPrice:b}=at(t.id),[i,U]=r.useState({to:h,chain:t,value:f,data:void 0});r.useEffect((()=>{(async()=>{let n,u;if(!v||!a||K||z)return;N(!0);let I=ne({chain:i.chain,transport:re(oe(i.chain,j,y))});if(c&&!i.data)return await I.simulateContract({address:m,chain:i.chain,abi:ce,functionName:"transfer",args:[h,f],account:a.address}).catch((l=>{if(l?.cause?.name==="ContractFunctionZeroDataError"||l?.message?.includes("returned no data"))return I.simulateContract({address:m,chain:i.chain,abi:rt,functionName:"transfer",args:[h,f],account:a.address}).catch((E=>{console.warn("Simulated token transfer failed with error, fetching bridge options.",E)}));console.warn("Simulated token transfer failed with error, fetching bridge options.",l)}))?(N(!1),void U({to:m,chain:i.chain,data:Re({abi:ce,functionName:"transfer",args:[h,f]}),value:"0x0"})):(N(!1),void V(!0));try{n=await I.prepareTransactionRequest({account:a.address,to:i.to,chain:i.chain,data:i.data,value:BigInt(i.value??0)})}catch(l){if(console.error(l),T.length>1)W(l.shortMessage??"Something went wrong");else if(q&&T.length===0)return void g(new S(`Wallet ${A(a.address)} does not have enough funds.`,void 0,x.INSUFFICIENT_BALANCE))}if(!n)return N(!1),void V(!0);N(!1),D(!0),ye(!0),Ce(n.gas);try{await v.switchChain({id:i.chain.id})}catch{await v.addChain({chain:i.chain}),await v.switchChain({id:i.chain.id})}try{u=await v.sendTransaction(n)}catch(l){if(console.error(l),l.name==="TransactionExecutionError")if(T.length<1){let E=l.shortMessage;(l.shortMessage.includes("rejected the request")||l.details.includes("rejected the request"))&&(E="User rejected the request."),g(new S(E,void 0,x.TRANSACTION_FAILURE))}else W(l.shortMessage??"Something went wrong")}if(u)return await v.waitForTransactionReceipt({hash:u}),D(!1),q?(Ee(u),void X("pending")):(G(!0),H(de(o,"completed",u,a?.walletClientType,c,s,t)),void O({eventName:ue,payload:{provider:"external",status:"success",txHash:u,address:a.address,chainId:i.chain.id,chainType:"ethereum",value:i.value?P(BigInt(i.value),s?.decimals??18):void 0,token:s?.symbol??m??"ETH",destinationAddress:h,destinationChainId:t.id,destinationChainType:"ethereum",destinationValue:f?P(f,s?.decimals??18):void 0,destinationToken:s?.symbol??m??t.nativeCurrency.name}}));D(!1)})().catch(console.error)}),[v,i]),r.useEffect((()=>{(async()=>{if(!Z||!v||!a)return;let n=nt(Y.chains).filter((e=>e.id!==t.id&&!!e.testnet==!!t.testnet));c&&n.unshift(t);let u=await ct({chains:n,address:a.address,appId:y,rpcConfig:j,includeUsdc:o.funding?.isUSDC}),I=c?u.filter((e=>e.balance>0n)):u.filter((e=>e.balance>f)),l=c&&u.every((e=>e.balance===0n));if(I.length<1)return void g(new S(l?`Wallet ${A(a.address)} doesn't have enough funds to cover gas fees. Top up your wallet and try again.`:`Wallet ${A(a.address)} does not have enough funds.`,void 0,x.INSUFFICIENT_BALANCE));I.sort(((e,F)=>Number(c?(F.erc20Balance??0n)-(e.erc20Balance??0n):F.balance-e.balance)));let E=I.flatMap((e=>{let F=[{...e,isErc20Quote:!1,isTestnet:!!t.testnet,input:Q({appId:y,amount:f.toString(),user:a.address,recipient:h,destinationChainId:t.id,destinationCurrency:m,originChainId:e.chain.id})}];return c&&m&&(e.erc20Balance??0n)>=f&&F.push({...e,isErc20Quote:!0,isTestnet:!!t.testnet,input:Q({appId:y,amount:f.toString(),user:a.address,recipient:h,destinationChainId:t.id,destinationCurrency:m,originChainId:e.chain.id,originCurrency:e.erc20Address})}),F})),ae=(await Promise.allSettled(E.map((async e=>({...e,quote:await me(e)}))))).filter((e=>e.status==="fulfilled")).map((e=>e.value));if(ae.length<1)return void g(new S(`Wallet ${A(a.address)} does not have enough funds.`,void 0,x.INSUFFICIENT_BALANCE));let L=ae.map((e=>({bridgeTx:fe(e.quote),balance:e.balance,chain:e.chain,erc20Balance:e.erc20Balance,isErc20Quote:e.isErc20Quote}))).filter((e=>!!e.bridgeTx));if(L.length>1)return void Te(L);let $=L[0];$?(B(!0),U({data:$.bridgeTx.data,to:$.bridgeTx.to,value:$.bridgeTx.value,chain:$.chain})):g(new S(`Wallet ${A(a.address)} does not have enough funds.`,void 0,x.INSUFFICIENT_BALANCE))})().catch(console.error)}),[Z]),dt({transactionHash:be,isTestnet:!!t.testnet,bridgingStatus:Se,setBridgingStatus:X,onSuccess({transactionHash:n}){B(!1),G(!0),H(de(o,"completed",n,a?.walletClientType,c,s,t)),O({eventName:ue,payload:{provider:"external",status:"success",txHash:n,address:a?.address,chainId:i.chain.id,chainType:"ethereum",value:i.value?P(BigInt(i.value),s?.decimals??18):void 0,token:s?.symbol??m??"ETH",destinationAddress:h,destinationChainId:t.id,destinationChainType:"ethereum",destinationValue:f?P(f,s?.decimals??18):void 0,destinationToken:s?.symbol??m??t.nativeCurrency.name}})},onFailure({error:n}){B(!1),g(n)}}),r.useEffect((()=>{M&&(H({funding:o?.funding,solanaFundingData:o?.solanaFundingData,sendTransaction:o?.sendTransaction,errorModalData:{error:M,previousScreen:"TransferFromWalletScreen"}}),pe("ErrorScreen",!1))}),[M]);let Ue=!c&&b?st(w??"0",b):void 0,k=c?C:ot([C,f]),ke=k&&b?le(k,b):void 0,Pe=k?R(k,o?.funding?.erc20Address?o?.funding?.erc20ContractInfo?.symbol||"ETH":o?.funding?.chain.nativeCurrency.symbol||"ETH"):void 0,He=C&&b?le(C,b):void 0,Me=C?R(C,t?.nativeCurrency?.symbol||"ETH"):void 0;if(r.useEffect((()=>{if(!_)return;let n=setTimeout(he,tt);return()=>clearTimeout(n)}),[_]),_)return d.jsxs(d.Fragment,{children:[d.jsx(se,{}),d.jsx(Oe,{}),d.jsxs(Ye,{children:[d.jsx(Qe,{color:"var(--privy-color-success)",width:"64px",height:"64px"}),d.jsx(Ve,{title:"Success!",description:`Youâ€™ve successfully added ${w} ${c?s.symbol:t.nativeCurrency.symbol} to your ${Y.name} wallet. It may take a minute before the funds are available to use.`})]}),d.jsx(Ze,{}),d.jsx(ie,{})]});let We=c?`${it({amount:je,decimals:s.decimals})}  ${s.symbol}`:R(Fe,t.nativeCurrency.symbol,3,!0),p=T[J];return T.length>1&&p?d.jsx(lt,{displayName:te,configuredFundingChain:t,erc20ContractInfo:s,formattedBalance:We,fundingAmount:w,fundingCurrency:c?s.symbol:t.nativeCurrency.symbol,fundingAmountInUsd:Ue,options:T,selectedOption:p,isPreparing:K,isSubmitting:z,addressToFund:h,fundingWalletAddress:a?.address||"",errorMessage:Ie,onSubmit:()=>{o.funding?.amount!==w?(async function(){if(a&&p)try{let n=await me({isTestnet:!!t.testnet,input:Q({appId:y,amount:f.toString(),user:a.address,recipient:h,destinationChainId:t.id,destinationCurrency:m,originChainId:p.chain.id})}),u=fe(n);if(!u)throw Error("Invalid transaction request");B(!0),U({data:u.data,to:u.to,value:u.value,chain:p.chain})}catch(n){console.error(n),g(new S("Unable to fetch quotes for bridging",n,x.INSUFFICIENT_BALANCE))}})().catch(console.error):U({to:p.bridgeTx.to,data:p.bridgeTx.data,value:p.bridgeTx.value,chain:p.chain})},onSelect:n=>{n!==J&&(W(null),we(n))},onAmountChange:xe}):ve&&C&&a&&o?.funding?d.jsx(mt,{walletClientType:a?.walletClientType||"unknown",displayName:te,addressToFund:h,isBridging:q,isErc20Flow:c,totalPriceInUsd:ke,totalPriceInNativeCurrency:Pe,gasPriceInUsd:He,gasPriceInNativeCurrency:Me,chainId:t.id,chainName:t.name}):d.jsxs(d.Fragment,{children:[d.jsx(se,{}),d.jsx(Je,{}),d.jsx("div",{style:{marginTop:"1rem"}}),d.jsx(ie,{})]})}};export{aa as AwaitingExternalEthereumTransferScreen,aa as default};
