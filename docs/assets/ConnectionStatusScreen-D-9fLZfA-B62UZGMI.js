import{j as m,i as we,g as me}from"./vendor-wallet-iWeBopzN.js";import{r as a}from"./vendor-react-NLnOsXgy.js";import{aH as C,b as j,a as he,r as ye,I as Ce,as as be,aA as Ee,O as _e,ar as y,aI as Te,aJ as J,aK as Re,ao as V,aL as B,aG as ve,aM as ke,E as b,aN as Ae,aO as Ie,aP as G,aq as Le,c as We}from"./index-BgfVDz5U.js";import{n as Q}from"./Link-DJ5gq9Di-B36AcpdD.js";import{n as ee}from"./useI18n-BuIe8nUA-D5eSzRO4.js";import{a as Oe}from"./shouldProceedtoEmbeddedWalletCreationFlow-BMF_3TVv-CIyILQ2-.js";import{n as Ue}from"./ScreenLayout-DTmQLGPf-Bt1BELRe.js";import"./ModalHeader-D8-mhjp4-DX69jG8H.js";import"./Screen-Bp-TN9gb-rb048SGm.js";import"./index-Dq_xe9dz-P-fAJJok.js";const Z=i=>{let c=localStorage.getItem("-walletlink:https://www.walletlink.org:Addresses")?.split(" ").filter((s=>we(s,{strict:!0}))).map((s=>me(s)));return!!c?.length&&!!i?.linkedAccounts.filter((s=>s.type=="wallet"&&c.includes(s.address))).length},Me=i=>i?.privyErrorCode===b.LINKED_TO_ANOTHER_USER?C.ERROR_USER_EXISTS:i instanceof Ae&&!i.details.default?i.details:i instanceof Ie?C.ERROR_TIMED_OUT:i?.privyErrorCode===b.CANNOT_LINK_MORE_OF_TYPE?C.ERROR_USER_LIMIT_REACHED:C.ERROR_WALLET_CONNECTION,xe=({walletLogo:i,title:c,subtitle:s,signSuccess:g,errorMessage:d,connectSuccess:u,separateConnectAndSign:E,signing:R,walletConnectRedirectUri:v,walletConnectFallbackUniversalUri:r,hasTabbedAway:k,showCoinbaseWalletResetCta:A,numRetries:U,onBack:h,onSign:p,onRetry:I,onCoinbaseReset:_,onDifferentWallet:f})=>{let{t:e}=ee(),M=A?{label:"Use a different wallet",onClick:_,disabled:g}:d===C.ERROR_USER_EXISTS&&h?{label:"Use a different wallet",onClick:f}:u&&!g&&E?{label:R?"Signing":"Sign with your wallet",onClick:p,disabled:R}:!g&&d?.retryable&&U<2?{label:"Retry",onClick:I,disabled:!1}:g||d?void 0:{label:e("connectionStatus.connecting"),onClick:()=>{},disabled:!0};return m.jsx(Ue,{title:c,subtitle:s,icon:i,iconVariant:"loading",iconLoadingStatus:{success:g,fail:!!d},primaryCta:M,onBack:h,watermark:!0,children:!u&&v&&!k&&m.jsxs(Ne,{children:[e("connectionStatus.stillHere")," ",m.jsx(Q,{href:v,target:"_blank",variant:"underlined",size:"sm",children:e("connectionStatus.tryConnectingAgain")}),r&&m.jsxs(m.Fragment,{children:[" ",e("connectionStatus.or")," ",m.jsx(Q,{href:r,target:"_blank",variant:"underlined",size:"sm",children:e("connectionStatus.useDifferentLink")})]})]})})},Pe={component:()=>{let i,[c,s]=a.useState(!1),[g,d]=a.useState(!1),[u,E]=a.useState(void 0),{authenticated:R,logout:v}=j(),{navigate:r,navigateBack:k,lastScreen:A,currentScreen:U,setModalData:h,data:p}=he(),I=ye(),{t:_}=ee(),{getAuthFlow:f,walletConnectionStatus:e,closePrivyModal:M,initLoginWithWallet:F,loginWithWallet:te,updateWallets:ne,createAnalyticsEvent:ae}=Ce(),{walletConnectors:oe}=j(),[L,ie]=a.useState(0),{user:w}=j(),re=be(),[le]=a.useState(w?.linkedAccounts.length||0),[H,ce]=a.useState(""),[se,de]=a.useState(""),[ue,q]=a.useState(!1),{hasTabbedAway:ge}=(function(){let[t,n]=a.useState(!1),o=a.useCallback((()=>{document.hidden&&n(!0)}),[]);return a.useEffect((()=>(document.addEventListener("visibilitychange",o),()=>document.removeEventListener("visibilitychange",o))),[o]),{hasTabbedAway:t,reset:()=>n(!1)}})(),{enabled:pe,token:X}=Ee(),x=_e(e?.connector?.walletClientType||"unknown"),T=y.isMobile&&e?.connector?.connectorType==="wallet_connect_v2"||y.isMobile&&e?.connector?.connectorType==="coinbase_wallet"||y.isMobile&&e?.connector?.connectorType==="base_account"||y.isMobile&&e?.connector?.connectorType==="injected"&&e?.connector?.walletClientType==="phantom"||y.isMobile&&e?.connector?.connectorType==="solana_adapter"&&e.connector.walletClientType==="mobile_wallet_adapter",S=e?.status==="connected",z=e?.status==="switching_to_supported_chain";a.useEffect((()=>{let t=f(),n=t instanceof G||t instanceof J?t:void 0;S&&e.connector?.chainType==="solana"&&e.connector?.walletClientType==="phantom"&&re(Te)&&p?.login?.isSigningInWithLedgerSolana===void 0?r("ConnectLedgerScreen",!1):(S&&!n&&(!pe||X||R?F(e.connectedWallet,X,p?.login?.disableSignup,p?.login?.isSigningInWithLedgerSolana?"transaction":"plain").then((()=>{q(!0)})):(h({captchaModalData:{callback:o=>F(e.connectedWallet,o,p?.login?.disableSignup,p?.login?.isSigningInWithLedgerSolana?"transaction":"plain").then((()=>{q(!0)})),userIntentRequired:!1,onSuccessNavigateTo:"ConnectionStatusScreen",onErrorNavigateTo:"ErrorScreen"}}),r("CaptchaScreen",!1))),n instanceof J&&p?.login?.isSigningInWithLedgerSolana&&(n.messageType="transaction"),n&&T&&S&&!n.preparedMessage?n.buildMessage():n&&!T&&S&&(g||(async()=>{d(!0),E(void 0);try{e?.connector?.connectorType==="wallet_connect_v2"&&e?.connector?.walletClientType==="metamask"&&await Re(2500),await N()}catch(o){console.warn("Auto-prompted signature failed",o)}finally{d(!1)}})()))}),[L,S,ue]),a.useEffect((()=>{if(w&&c){let t=V-500;if(I?.legal.requireUsersAcceptTerms&&!w.hasAcceptedTerms){let o=setTimeout((()=>{r("AffirmativeConsentScreen")}),t);return()=>clearTimeout(o)}if(Oe(w,I.embeddedWallets)){let o=setTimeout((()=>{h({createWallet:{onSuccess:()=>{},onFailure:O=>{console.error(O),ae({eventName:"embedded_wallet_creation_failure_logout",payload:{error:O,screen:"ConnectionStatusScreen"}}),v()},callAuthOnSuccessOnClose:!0}}),r("EmbeddedWalletOnAccountCreateScreen")}),t);return()=>clearTimeout(o)}ne();let n=setTimeout((()=>M({shouldCallAuthOnSuccess:!0,isSuccess:!0})),V);return()=>clearTimeout(n)}}),[w,c]);let K=t=>{if(t?.privyErrorCode!==b.ALLOWLIST_REJECTED){if(t?.privyErrorCode===b.USER_LIMIT_REACHED)return console.error(new Le(t).toString()),void r("UserLimitReachedScreen");if(t?.privyErrorCode!==b.USER_DOES_NOT_EXIST)return t?.privyErrorCode===b.ACCOUNT_TRANSFER_REQUIRED&&t.data?.data?.nonce?(h({accountTransfer:{nonce:t.data?.data?.nonce,account:f()?.meta.address,displayName:t.data?.data?.account?.displayName,externalWalletMetadata:{walletClientType:f()?.meta.walletClientType,chainId:f()?.meta.chainId,connectorType:f()?.meta.connectorType},linkMethod:f()instanceof G?"siwe":"siws",embeddedWalletAddress:t.data?.data?.otherUser?.embeddedWalletAddress}}),void r("LinkConflictScreen")):void E(Me(t));r("AccountNotFoundScreen")}else r("AllowlistRejectionScreen")};async function N(){try{await te(),s(!0)}catch(t){K(t)}finally{d(!1)}}a.useEffect((()=>{e?.connectError&&K(e?.connectError)}),[e]),((t,n)=>{let o=a.useRef((()=>{}));a.useEffect((()=>{o.current=t})),a.useEffect((()=>{if(n!==null){let O=setInterval((()=>o.current()),n||0);return()=>clearInterval(O)}}),[n])})((()=>{let t=W==="wallet_connect_v2"&&e?.connector instanceof B?e.connector.redirectUri:void 0;t&&ce(t);let n=W==="wallet_connect_v2"&&e?.connector instanceof B?e.connector.fallbackUniversalRedirectUri:void 0;n&&de(n)}),e?.connector instanceof B&&!H?500:null);let W=e?.connector?.connectorType||"injected",D=e?.connector?.walletClientType||"unknown",$=x?.metadata?.shortName||x?.name||e?.connector?.walletBranding.name||"Browser Extension",Se=x?.image_url?.md||e?.connector?.walletBranding.icon||(t=>m.jsx(ve,{...t})),P=$==="Browser Extension"?$.toLowerCase():$;i=c?_("connectionStatus.successfullyConnected",{walletName:P}):u?_("connectionStatus.errorTitle",{errorMessage:u.message}):z?"Switching networks":S?g&&T?"Signing":"Sign to verify":`Waiting for ${P}`;let l=_("connectionStatus.checkOtherWindows");c?l=le===(w?.linkedAccounts.length||0)?"Wallet was already linked.":"You're good to go!":L>=2&&u?l="Unable to connect wallet":u?l=u.detail:z?l="Switch your wallet to the requested network.":S&&T?l="Sign the message in your wallet to verify it belongs to you.":D==="metamask"&&y.isMobile?l="Click continue to open and connect MetaMask.":D==="metamask"?l="For the best experience, connect only one wallet at a time.":W==="wallet_connect"?l="Open your mobile wallet app to continue":W==="coinbase_wallet"?ke()||(l=Z(w)?"Continue with the Coinbase app. Not the right wallet? Reset your connection below.":"Confirm in the Coinbase app/popup to continue."):p?.login?.isSigningInWithLedgerSolana&&(l="Ledger requires a transaction to verify your identity. You'll sign a transaction that performs no onchain action.");let Y=oe?.walletConnectors?.find((t=>t.walletClientType==="coinbase_wallet")),fe=D==="coinbase_wallet"&&(Z(w)||u===C.ERROR_USER_EXISTS);return m.jsx(xe,{walletLogo:Se,title:i,subtitle:l,signSuccess:c,errorMessage:u,connectSuccess:S,separateConnectAndSign:T,signing:g,walletConnectRedirectUri:H,walletConnectFallbackUniversalUri:se,hasTabbedAway:ge,showCoinbaseWalletResetCta:fe,numRetries:L,onBack:A&&U!==A?k:void 0,onSign:()=>{d(!0),N()},onRetry:()=>{ie(L+1),E(void 0),S?(d(!0),N()):e?.connectRetry()},onCoinbaseReset:()=>{Y&&Y?.disconnect()},onDifferentWallet:k})}};let Ne=We.p`
  text-align: center;
  color: var(--privy-color-foreground-2);
  font-size: 14px;
  line-height: 22px;
  margin: 16px 0;
`;export{Pe as ConnectionStatusScreen,xe as ConnectionStatusView,Pe as default,Me as getErrorDetails};
