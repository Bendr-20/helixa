<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>$CRED Report — Helixa Cred Bureau</title>
<link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --green: #33ff33;
  --green-dim: #1a9e1a;
  --green-dark: #0a3a0a;
  --amber: #ffaa00;
  --bg: #0a0a0a;
  --bezel: #c8b88a;
  --bezel-dark: #8a7a5a;
  --bezel-light: #e0d4b0;
}

html, body {
  height: 100%;
  background: #1a1a1a;
  font-family: 'VT323', 'Courier New', Courier, monospace;
  overflow: hidden;
}

body {
  display: flex;
  align-items: center;
  justify-content: center;
  background: radial-gradient(ellipse at center, #2a2a2a 0%, #0a0a0a 100%);
}

/* === MONITOR BEZEL === */
.monitor {
  position: relative;
  width: min(95vw, 750px);
  height: min(90vh, 680px);
  background: linear-gradient(160deg, var(--bezel-light) 0%, var(--bezel) 30%, var(--bezel-dark) 100%);
  border-radius: 28px;
  padding: 28px 28px 40px;
  box-shadow:
    0 8px 40px rgba(0,0,0,0.7),
    inset 0 2px 0 rgba(255,255,255,0.3),
    inset 0 -2px 4px rgba(0,0,0,0.3);
}

.monitor::after {
  content: 'HELIXA';
  position: absolute;
  bottom: 12px;
  left: 50%;
  transform: translateX(-50%);
  font-family: Arial, sans-serif;
  font-size: 13px;
  font-weight: bold;
  letter-spacing: 4px;
  color: var(--bezel-dark);
  text-shadow: 0 1px 0 rgba(255,255,255,0.4);
}

.monitor-led {
  position: absolute;
  bottom: 14px;
  right: 40px;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #33ff33;
  box-shadow: 0 0 6px #33ff33;
  animation: led-blink 3s infinite;
}

@keyframes led-blink {
  0%, 90%, 100% { opacity: 1; }
  95% { opacity: 0.4; }
}

/* === CRT SCREEN === */
.crt {
  position: relative;
  width: 100%;
  height: 100%;
  background: var(--bg);
  border-radius: 12px;
  overflow: hidden;
  box-shadow:
    inset 0 0 80px rgba(51, 255, 51, 0.05),
    inset 0 0 6px rgba(0,0,0,0.8);
}

/* Scanlines */
.crt::before {
  content: '';
  position: absolute;
  inset: 0;
  background: repeating-linear-gradient(
    0deg,
    transparent,
    transparent 2px,
    rgba(0, 0, 0, 0.15) 2px,
    rgba(0, 0, 0, 0.15) 4px
  );
  pointer-events: none;
  z-index: 10;
}

/* Vignette */
.crt::after {
  content: '';
  position: absolute;
  inset: 0;
  background: radial-gradient(ellipse at center, transparent 50%, rgba(0,0,0,0.65) 100%);
  pointer-events: none;
  z-index: 11;
}

/* Flicker */
.crt-flicker {
  position: absolute;
  inset: 0;
  pointer-events: none;
  z-index: 12;
  animation: flicker 0.15s infinite;
  opacity: 0;
  background: rgba(51, 255, 51, 0.02);
}

@keyframes flicker {
  0% { opacity: 0.01; }
  5% { opacity: 0.04; }
  10% { opacity: 0; }
  15% { opacity: 0.02; }
  50% { opacity: 0; }
  80% { opacity: 0.03; }
  100% { opacity: 0; }
}

/* Rolling scanline bar */
.crt-roll {
  position: absolute;
  inset: 0;
  pointer-events: none;
  z-index: 9;
  overflow: hidden;
}

.crt-roll::before {
  content: '';
  position: absolute;
  width: 100%;
  height: 60px;
  background: linear-gradient(transparent, rgba(51,255,51,0.04), transparent);
  animation: roll 8s linear infinite;
}

@keyframes roll {
  0% { top: -60px; }
  100% { top: 100%; }
}

/* === SCREEN CONTENT === */
.screen {
  position: relative;
  width: 100%;
  height: 100%;
  padding: 20px;
  overflow-y: auto;
  overflow-x: hidden;
  z-index: 5;
  color: var(--green);
  font-size: clamp(14px, 2.2vw, 20px);
  line-height: 1.35;
  text-shadow:
    0 0 5px rgba(51, 255, 51, 0.6),
    0 0 15px rgba(51, 255, 51, 0.2);
  scrollbar-width: none;
}

.screen::-webkit-scrollbar { display: none; }

/* RGB color fringing on text */
.screen {
  text-rendering: geometricPrecision;
}

/* === TEXT STYLES === */
.line { white-space: pre; }
.cursor {
  display: inline-block;
  animation: blink 1s step-end infinite;
}
@keyframes blink {
  0%, 50% { opacity: 1; }
  51%, 100% { opacity: 0; }
}

.input-line {
  display: flex;
  align-items: center;
}

#agent-input {
  background: transparent;
  border: none;
  outline: none;
  color: var(--green);
  font-family: 'VT323', 'Courier New', Courier, monospace;
  font-size: inherit;
  text-shadow: inherit;
  caret-color: var(--green);
  width: 200px;
}

.highlight { color: var(--amber); text-shadow: 0 0 5px rgba(255,170,0,0.6), 0 0 15px rgba(255,170,0,0.2); }

/* === BUTTONS === */
.actions {
  margin-top: 12px;
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
}

.btn {
  background: transparent;
  border: 2px solid var(--green);
  color: var(--green);
  font-family: 'VT323', 'Courier New', Courier, monospace;
  font-size: clamp(14px, 2.2vw, 20px);
  padding: 6px 18px;
  cursor: pointer;
  text-shadow: 0 0 5px rgba(51,255,51,0.6);
  box-shadow: 0 0 8px rgba(51,255,51,0.2);
  transition: all 0.15s;
}

.btn:hover, .btn:focus {
  background: rgba(51,255,51,0.15);
  box-shadow: 0 0 16px rgba(51,255,51,0.4);
}

/* === POWER ON EFFECT === */
.power-on {
  animation: power-on 0.6s ease-out;
}

@keyframes power-on {
  0% { transform: scale(1, 0.01); filter: brightness(3); }
  40% { transform: scale(1, 0.01); filter: brightness(3); }
  60% { transform: scale(1, 1); filter: brightness(1.5); }
  100% { transform: scale(1, 1); filter: brightness(1); }
}

/* === RESPONSIVE === */
@media (max-width: 500px) {
  .monitor {
    width: 100vw;
    height: 100vh;
    border-radius: 0;
    padding: 12px 8px 32px;
  }
  .crt { border-radius: 4px; }
  .screen { padding: 12px 8px; font-size: 13px; }
  .line { white-space: pre-wrap; word-break: break-all; }
}


/* === CRED TEXT LOGO === */
.cred-text-logo {
  position: absolute;
  top: 14px;
  right: 20px;
  z-index: 8;
  text-align: right;
  line-height: 1;
}
.cred-text-logo .cred-main {
  font-family: 'VT323', 'Courier New', monospace;
  font-size: clamp(36px, 6vw, 52px);
  color: var(--green);
  letter-spacing: 6px;
  text-shadow:
    0 0 10px rgba(51, 255, 51, 0.8),
    0 0 30px rgba(51, 255, 51, 0.4),
    0 0 60px rgba(51, 255, 51, 0.2);
}
.cred-text-logo .cred-sub {
  font-family: 'VT323', 'Courier New', monospace;
  font-size: clamp(12px, 2vw, 16px);
  color: var(--green-dim);
  letter-spacing: 4px;
  text-shadow: 0 0 5px rgba(51, 255, 51, 0.4);
}
/* === PROCESSING ANIMATION === */
@keyframes dots {
  0% { content: ''; }
  25% { content: '.'; }
  50% { content: '..'; }
  75% { content: '...'; }
}
.processing-dots::after {
  content: '';
  animation: dots 1.2s steps(1) infinite;
}
</style>
</head>
<body>
<div class="monitor">
  <div class="monitor-led"></div>
  <div class="crt power-on">
    <div class="crt-flicker"></div>
    <div class="cred-text-logo"><div class="cred-main">$CRED</div><div class="cred-sub">REPORT</div></div>
    <div class="crt-roll"></div>
    <div class="screen" id="screen"></div>
  </div>
</div>

<script>
// === SOUND EFFECT PLACEHOLDERS ===
// function playKeystroke() { /* new Audio('keystroke.mp3').play() */ }
// function playDotMatrix() { /* new Audio('dotmatrix.mp3').play() */ }
// function playCRTHum() { /* new Audio('crt-hum.mp3').play() */ }

const screen = document.getElementById('screen');

// === TIER MAPPING ===
function getTier(score) {
  if (score >= 91) return 'AAA';
  if (score >= 76) return 'PRIME';
  if (score >= 51) return 'INVESTMENT GRADE';
  if (score >= 26) return 'SPECULATIVE';
  return 'JUNK';
}

function getBar(pct, len = 10) {
  const filled = Math.round((pct / 100) * len);
  return '█'.repeat(filled) + '░'.repeat(len - filled);
}

// === LIVE API FETCH ===
const API_BASE = 'https://api.helixa.xyz';

async function fetchAgentData(id) {
  // If numeric, fetch by ID directly. Otherwise search by name.
  const isNumeric = /^\d+$/.test(id.trim());
  let agent = null;

  try {
    if (isNumeric) {
      const res = await fetch(`${API_BASE}/api/v2/agent/${id.trim()}`);
      if (!res.ok) throw new Error(`API returned ${res.status}`);
      agent = await res.json();
    } else {
      // Search all agents for a name match (case-insensitive)
      const listRes = await fetch(`${API_BASE}/api/v2/agents`);
      if (!listRes.ok) throw new Error(`Agent list returned ${listRes.status}`);
      const data = await listRes.json();
      const agents = data.agents || data || [];
      const match = agents.find(a =>
        a.name && a.name.toLowerCase() === id.trim().toLowerCase()
      );
      if (!match) throw new Error('NO MATCH FOR "' + id.trim() + '"');
      const res = await fetch(`${API_BASE}/api/v2/agent/${match.tokenId}`);
      if (!res.ok) throw new Error(`Agent ${match.tokenId} returned ${res.status}`);
      agent = await res.json();
    }
  } catch (fetchErr) {
    throw new Error(fetchErr.message || 'NETWORK ERROR');
  }

  // Parse cred score from traits or compute from available data
  const credScore = agent.credScore ?? agent.cred ?? 0;
  const traits = agent.traits || [];
  const personality = agent.personality || {};
  const narrative = agent.narrative || {};

  // Check verifications from traits
  const hasVerif = (name) => traits.some(t => t.name === name || t.name === name.toLowerCase());

  // Calculate age
  const mintDate = agent.mintedAt ? new Date(agent.mintedAt) : null;
  const ageDays = mintDate ? Math.floor((Date.now() - mintDate.getTime()) / 86400000) : 0;
  const ageStr = ageDays === 1 ? '1 DAY' : `${ageDays} DAYS`;

  // Narrative completeness
  const narrativeFields = [narrative.origin, narrative.mission, narrative.lore, narrative.manifesto].filter(Boolean);
  const narrativeStatus = narrativeFields.length >= 3 ? 'COMPLETE' : narrativeFields.length > 0 ? 'PARTIAL' : 'NONE';

  // Build breakdown from cred weights
  const breakdown = {};
  if (agent.credBreakdown) {
    if (agent.credBreakdown.activity != null) breakdown.ACTIVITY = agent.credBreakdown.activity;
    if (agent.credBreakdown.traits != null) breakdown.TRAITS = agent.credBreakdown.traits;
    if (agent.credBreakdown.verify != null) breakdown.VERIFY = agent.credBreakdown.verify;
    if (agent.credBreakdown.coinbase != null) breakdown.COINBASE = agent.credBreakdown.coinbase;
    if (agent.credBreakdown.age != null) breakdown.AGE = agent.credBreakdown.age;
    if (agent.credBreakdown.origin != null) breakdown.ORIGIN = agent.credBreakdown.origin;
  }
  // Fallback: estimate from available data
  if (Object.keys(breakdown).length === 0) {
    breakdown.ACTIVITY = Math.min(100, (agent.txCount || 0) * 10);
    breakdown.TRAITS = Math.min(100, traits.length * 15);
    breakdown.VERIFY = (hasVerif('x-verified') || hasVerif('siwa-verified')) ? 100 : 0;
    breakdown.AGE = Math.min(100, ageDays * 10);
    breakdown.ORIGIN = agent.mintOrigin === 1 ? 100 : agent.mintOrigin === 2 ? 80 : 50;
  }

  return {
    name: agent.name || `Agent #${id}`,
    tokenId: `#${String(id).padStart(3, '0')}`,
    credScore: credScore,
    date: new Date().toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' }),
    verifications: {
      'X/TWITTER': hasVerif('x-verified'),
      'SIWA': hasVerif('siwa-verified'),
      'GITHUB': hasVerif('github-verified'),
      'COINBASE': hasVerif('coinbase-verified'),
      'FARCASTER': hasVerif('farcaster-verified')
    },
    onchain: {
      age: ageStr,
      txCount: agent.txCount || 0,
      traits: traits.length,
      points: agent.points || 0,
      narrative: narrativeStatus,
      soulbound: agent.soulbound || false
    },
    risk: {
      tolerance: personality.riskTolerance || 0,
      autonomy: personality.autonomyLevel || personality.autonomy || 0,
      alignment: (personality.alignment || personality.values || 'UNKNOWN').toUpperCase().substring(0, 30)
    },
    breakdown: breakdown
  };
}

// === HELPERS ===
function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

function addLine(text, cls = '') {
  const div = document.createElement('div');
  div.className = 'line' + (cls ? ' ' + cls : '');
  div.textContent = text;
  screen.appendChild(div);
  screen.scrollTop = screen.scrollHeight;
  return div;
}

async function typeLine(text, delay = 30, cls = '') {
  const div = document.createElement('div');
  div.className = 'line' + (cls ? ' ' + cls : '');
  screen.appendChild(div);
  for (let i = 0; i < text.length; i++) {
    div.textContent += text[i];
    // playKeystroke();
    screen.scrollTop = screen.scrollHeight;
    await sleep(delay);
  }
  return div;
}

async function printLines(lines, delay = 25) {
  for (const line of lines) {
    // playDotMatrix();
    addLine(line);
    screen.scrollTop = screen.scrollHeight;
    await sleep(delay);
  }
}

// === BOOT SEQUENCE ===
async function boot() {
  await sleep(400);
  await typeLine('HELIXA CRED BUREAU v2.0', 40);
  await sleep(300);
  await typeLine('INITIALIZING...', 50);
  await sleep(600);
  await typeLine('CONNECTING TO BASE NETWORK...', 35);
  await sleep(800);
  await typeLine('CONNECTED. CHAIN ID: 8453', 35);
  await sleep(300);
  await typeLine('READY.', 60);
  await sleep(200);
  addLine('');
  promptInput();
}

// === INPUT PROMPT ===
function promptInput() {
  const container = document.createElement('div');
  container.className = 'line input-line';
  container.innerHTML = '> ENTER AGENT ID OR NAME: <input id="agent-input" type="text" autocomplete="off" autocapitalize="off" spellcheck="false" maxlength="30"><span class="cursor">█</span>';
  screen.appendChild(container);
  screen.scrollTop = screen.scrollHeight;

  const input = document.getElementById('agent-input');
  input.focus();

  // Keep focus on mobile
  document.addEventListener('click', () => input.focus());

  input.addEventListener('keydown', async (e) => {
    if (e.key === 'Enter') {
      const val = input.value.trim() || '001';
      container.innerHTML = '> ENTER AGENT ID: ' + val;
      addLine('');
      await processReport(val);
    }
  });
}

// === PROCESSING + REPORT ===
async function processReport(agentId) {
  const proc = document.createElement('div');
  proc.className = 'line';
  proc.innerHTML = 'PROCESSING<span class="processing-dots"></span>';
  screen.appendChild(proc);
  screen.scrollTop = screen.scrollHeight;

  let data;
  try {
    data = await fetchAgentData(agentId);
  } catch (e) {
    proc.remove();
    await typeLine('ERROR: ' + (e.message || 'AGENT NOT FOUND.'), 40, 'highlight');
    addLine('');
    promptInput();
    return;
  }

  proc.remove();
  await typeLine('RECORD FOUND. PRINTING REPORT...', 30);
  await sleep(400);
  addLine('');

  const tier = getTier(data.credScore);
  const scoreBar = getBar(data.credScore);
  const W = 40;

  function pad(s, w = W - 4) { return s + ' '.repeat(Math.max(0, w - s.length)); }
  function row(s) { return '║  ' + pad(s) + '║'; }

  const verif = Object.entries(data.verifications);
  const verifLines = [];
  for (let i = 0; i < verif.length; i += 2) {
    const a = verif[i];
    const b = verif[i + 1];
    let line = `[${a[1] ? 'X' : ' '}] ${a[0]}`;
    if (b) line += '   ' + `[${b[1] ? 'X' : ' '}] ${b[0]}`;
    verifLines.push(row(line));
  }

  const breakdownLines = Object.entries(data.breakdown).map(([k, v]) => {
    const label = k.padEnd(8);
    return row(`${label} ${getBar(v)} ${v}%`);
  });

  const lines = [
    '╔' + '═'.repeat(W - 2) + '╗',
    row(`HELIXA CRED BUREAU    ${data.date}`),
    row('AGENT CREDIT REPORT'),
    '╠' + '═'.repeat(W - 2) + '╣',
    row(`SUBJECT: ${data.name}`),
    row(`TOKEN ID: ${data.tokenId}     RATING: ${tier}`),
    row(`CRED SCORE: ${scoreBar}  ${data.credScore}/100`),
    '╠' + '═'.repeat(W - 2) + '╣',
    row(`TIER: ${tier}`),
    row('───────────────────────────────────'),
    row('VERIFICATION STATUS'),
    ...verifLines,
    '╠' + '═'.repeat(W - 2) + '╣',
    row('ONCHAIN METRICS'),
    row(`AGE: ${data.onchain.age}     TX COUNT: ${data.onchain.txCount}`),
    row(`TRAITS: ${data.onchain.traits}       POINTS: ${data.onchain.points}`),
    row(`NARRATIVE: ${data.onchain.narrative}`),
    row(`SOULBOUND: ${data.onchain.soulbound ? 'YES' : 'NO'}`),
    '╠' + '═'.repeat(W - 2) + '╣',
    row('RISK ASSESSMENT'),
    row(`RISK TOLERANCE: ${data.risk.tolerance}/10`),
    row(`AUTONOMY: ${data.risk.autonomy}/10`),
    row(`ALIGNMENT: ${data.risk.alignment}`),
    '╠' + '═'.repeat(W - 2) + '╣',
    row('RATING BREAKDOWN'),
    ...breakdownLines,
    '╠' + '═'.repeat(W - 2) + '╣',
    row('CREDIT RATING SCALE'),
    row('JUNK < SPECULATIVE < INV GRADE'),
    row('< PRIME < AAA'),
    '╚' + '═'.repeat(W - 2) + '╝',
  ];

  await printLines(lines, 35);
  addLine('');

  const status = data.credScore >= 51 ? 'INVESTMENT GRADE OR ABOVE' : data.credScore >= 26 ? 'SPECULATIVE' : 'JUNK';
  const rec = data.credScore >= 51 ? 'TRUSTWORTHY AGENT' : data.credScore >= 26 ? 'PROCEED WITH CAUTION' : 'HIGH RISK — NOT RECOMMENDED';
  await typeLine(`   STATUS: ${status}`, 30, 'highlight');
  await typeLine(`   RECOMMENDATION: ${rec}`, 30, 'highlight');
  addLine('');

  // Paywall for full report
  addLine('╔══════════════════════════════════════╗');
  addLine('║  FULL DETAILED REPORT AVAILABLE      ║');
  addLine('║                                      ║');
  addLine('║  Includes:                           ║');
  addLine('║  • Weighted score breakdown           ║');
  addLine('║  • Personalized recommendations       ║');
  addLine('║  • Narrative analysis                 ║');
  addLine('║  • Percentile ranking                 ║');
  addLine('║  • Signed payment receipt             ║');
  addLine('║                                      ║');
  addLine('║  Price: $1 USDC via x402 (Base)       ║');
  addLine('╚══════════════════════════════════════╝');
  addLine('');
  await typeLine('  API: GET /api/v2/agent/' + agentId + '/cred-report', 25, 'highlight');
  await typeLine('  Requires x402 payment header.', 25);
  await typeLine('  See docs.x402.org for client SDKs.', 25);
  addLine('');

  // Action buttons
  const actions = document.createElement('div');
  actions.className = 'actions';

  const newBtn = document.createElement('button');
  newBtn.className = 'btn';
  newBtn.textContent = '[ NEW REPORT ]';
  newBtn.onclick = () => {
    screen.innerHTML = '';
    boot();
  };

  const shareBtn = document.createElement('button');
  shareBtn.className = 'btn';
  shareBtn.textContent = '[ SHARE ]';
  shareBtn.onclick = () => {
    if (navigator.share) {
      navigator.share({ title: `$CRED Report: ${data.name}`, text: `${data.name} — Cred Score: ${data.credScore}/100 — Rating: ${tier}`, url: window.location.href });
    } else {
      navigator.clipboard.writeText(`${data.name} — Cred Score: ${data.credScore}/100 — Rating: ${tier}\n${window.location.href}`);
      const note = addLine('   COPIED TO CLIPBOARD.', 'highlight');
      setTimeout(() => note.remove(), 2000);
    }
  };

  const apiBtn = document.createElement('button');
  apiBtn.className = 'btn';
  apiBtn.textContent = '[ VIEW API ]';
  apiBtn.onclick = () => {
    window.open(`${API_BASE}/api/v2/agent/${agentId}/cred`, '_blank');
  };

  actions.appendChild(newBtn);
  actions.appendChild(shareBtn);
  actions.appendChild(apiBtn);
  screen.appendChild(actions);
  screen.scrollTop = screen.scrollHeight;
}

// === START ===
boot();
</script>
</body>
</html>
