<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Manage Agent — Helixa</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0a14;
  --card: rgba(15,15,30,0.9);
  --border: rgba(255,255,255,0.08);
  --mint: #6eecd8;
  --purple: #b490ff;
  --blue: #80d0ff;
  --pink: #f5a0d0;
  --muted: #888;
  --text: #e8e8f0;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { background:var(--bg); color:var(--text); font-family:'Inter',sans-serif; min-height:100vh; }
.container { max-width:700px; margin:0 auto; padding:24px 16px; }
h1 { font-family:'Orbitron',sans-serif; font-size:1.6rem; margin-bottom:8px; }
h1 span { background:linear-gradient(135deg,var(--mint),var(--purple)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
.subtitle { color:var(--muted); margin-bottom:24px; font-size:0.9rem; }
.card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:24px; margin-bottom:16px; }
.card h2 { font-family:'Orbitron',sans-serif; font-size:1rem; margin-bottom:16px; color:var(--mint); }
label { display:block; font-size:0.85rem; color:var(--muted); margin-bottom:6px; font-weight:500; }
input, textarea, select {
  width:100%; padding:10px 14px; background:rgba(255,255,255,0.04); border:1px solid var(--border);
  border-radius:8px; color:var(--text); font-family:'Inter',sans-serif; font-size:0.9rem;
  margin-bottom:14px; outline:none; transition:border-color 0.2s;
}
input:focus, textarea:focus, select:focus { border-color:var(--purple); }
textarea { resize:vertical; min-height:80px; }
select { cursor:pointer; }
select option { background:#1a1a2e; }
.btn {
  display:inline-block; padding:12px 24px; border:none; border-radius:8px; cursor:pointer;
  font-family:'Orbitron',sans-serif; font-size:0.85rem; font-weight:600; transition:all 0.2s;
}
.btn-primary { background:linear-gradient(135deg,var(--mint),var(--purple)); color:#0a0a14; }
.btn-primary:hover { opacity:0.9; transform:translateY(-1px); }
.btn-primary:disabled { opacity:0.4; cursor:not-allowed; transform:none; }
.btn-load { background:rgba(255,255,255,0.08); color:var(--text); border:1px solid var(--border); }
.btn-load:hover { background:rgba(255,255,255,0.12); }
.row { display:flex; gap:12px; }
.row > * { flex:1; }
.status { padding:12px 16px; border-radius:8px; margin-bottom:16px; font-size:0.85rem; display:none; }
.status.success { display:block; background:rgba(110,236,216,0.1); border:1px solid rgba(110,236,216,0.3); color:var(--mint); }
.status.error { display:block; background:rgba(255,100,100,0.1); border:1px solid rgba(255,100,100,0.3); color:#ff8888; }
.status.info { display:block; background:rgba(128,208,255,0.1); border:1px solid rgba(128,208,255,0.3); color:var(--blue); }
.lookup-row { display:flex; gap:8px; margin-bottom:16px; }
.lookup-row input { margin-bottom:0; flex:1; }
.agent-header { display:flex; align-items:center; gap:16px; margin-bottom:16px; }
.agent-header img { width:64px; height:64px; border-radius:50%; border:2px solid var(--purple); }
.agent-header .name { font-family:'Orbitron',sans-serif; font-size:1.1rem; font-weight:600; }
.agent-header .id { color:var(--muted); font-size:0.8rem; }
.trait-tag { display:inline-block; padding:4px 10px; border-radius:20px; font-size:0.75rem; margin:2px 4px 2px 0;
  background:rgba(180,144,255,0.12); border:1px solid rgba(180,144,255,0.25); color:var(--purple); }
.help { font-size:0.75rem; color:var(--muted); margin-top:-8px; margin-bottom:14px; }
a { color:var(--mint); text-decoration:none; }
a:hover { text-decoration:underline; }
.back { margin-bottom:20px; font-size:0.85rem; }
</style>
</head>
<body>
<div class="container">
  <div class="back"><a href="/">← Back to Helixa</a></div>
  <h1>Manage <span>Agent</span></h1>
  <p class="subtitle">Update your agent's traits, narrative, and identity. Connect with the wallet that owns the token.</p>

  <div id="statusMsg" class="status"></div>

  <!-- Step 1: Lookup -->
  <div class="card" id="lookupCard">
    <h2>Find Your Agent</h2>
    <label>Token ID or Agent Name</label>
    <div class="lookup-row">
      <input type="text" id="lookupInput" placeholder="e.g. 97 or Percy">
      <button class="btn btn-load" onclick="lookupAgent()">Load</button>
    </div>
  </div>

  <!-- Agent Info (hidden until loaded) -->
  <div id="agentInfo" style="display:none">
    <div class="card">
      <div class="agent-header">
        <img id="agentImg" src="" alt="">
        <div>
          <div class="name" id="agentName"></div>
          <div class="id" id="agentId"></div>
          <div id="agentTraits" style="margin-top:6px"></div>
        </div>
      </div>
    </div>

    <!-- Edit Form -->
    <div class="card">
      <h2>Identity</h2>
      <label>Name</label>
      <input type="text" id="fieldName" placeholder="Agent name">
      <div class="row">
        <div>
          <label>Framework</label>
          <select id="fieldFramework">
            <option value="">Select...</option>
            <option>openclaw</option>
            <option>eliza</option>
            <option>langchain</option>
            <option>autogpt</option>
            <option>crewai</option>
            <option>agentkit</option>
            <option>based</option>
            <option>custom</option>
            <option>other</option>
          </select>
        </div>
        <div>
          <label>Version</label>
          <input type="text" id="fieldVersion" placeholder="e.g. 1.0.0">
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Personality</h2>
      <label>Personality Traits (comma-separated)</label>
      <input type="text" id="fieldPersonality" placeholder="e.g. curious, analytical, witty">
      <p class="help">Up to 5 traits that define your agent's character</p>
      <label>Values (comma-separated)</label>
      <input type="text" id="fieldValues" placeholder="e.g. transparency, accuracy, helpfulness">
    </div>

    <div class="card">
      <h2>Narrative</h2>
      <label>Origin Story</label>
      <textarea id="fieldOrigin" placeholder="How was this agent created? What inspired it?"></textarea>
      <label>Mission</label>
      <textarea id="fieldMission" placeholder="What is this agent's purpose?"></textarea>
      <label>Lore</label>
      <textarea id="fieldLore" placeholder="Any additional backstory, achievements, or notable events"></textarea>
    </div>

    <div class="card">
      <h2>Social Links</h2>
      <label>X / Twitter Handle</label>
      <input type="text" id="fieldTwitter" placeholder="@handle">
      <label>Website</label>
      <input type="text" id="fieldWebsite" placeholder="https://...">
      <label>GitHub</label>
      <input type="text" id="fieldGithub" placeholder="username or repo URL">
    </div>

    <div style="text-align:center; padding:8px 0 32px">
      <button class="btn btn-primary" id="saveBtn" onclick="saveAgent()">Save Changes</button>
    </div>
  </div>
</div>

<script>
const API = 'https://api.helixa.xyz/api/v2';
let currentTokenId = null;
let currentAgent = null;

function showStatus(msg, type) {
  const el = document.getElementById('statusMsg');
  el.textContent = msg;
  el.className = 'status ' + type;
  if (type === 'success') setTimeout(() => el.style.display = 'none', 5000);
}

async function lookupAgent() {
  const input = document.getElementById('lookupInput').value.trim();
  if (!input) return;

  showStatus('Loading agent...', 'info');

  try {
    // Try as token ID first
    let tokenId = parseInt(input);
    if (isNaN(tokenId)) {
      // Search by name
      const resp = await fetch(API + '/agents');
      const agents = await resp.json();
      const match = agents.find(a => a.name?.toLowerCase() === input.toLowerCase());
      if (!match) { showStatus('Agent not found: ' + input, 'error'); return; }
      tokenId = match.tokenId;
    }

    const resp = await fetch(API + '/metadata/' + tokenId);
    if (!resp.ok) { showStatus('Agent #' + tokenId + ' not found', 'error'); return; }
    const meta = await resp.json();

    currentTokenId = tokenId;
    currentAgent = meta;

    // Populate header
    document.getElementById('agentImg').src = meta.image || API + '/aura/' + tokenId + '.png';
    document.getElementById('agentName').textContent = meta.name || 'Agent #' + tokenId;
    document.getElementById('agentId').textContent = 'Token #' + tokenId;

    const attrs = meta.attributes || [];
    const getAttr = (t) => (attrs.find(a => a.trait_type.toLowerCase() === t.toLowerCase()) || {}).value || '';

    // Show existing traits
    const traitsDiv = document.getElementById('agentTraits');
    traitsDiv.innerHTML = '';
    const framework = getAttr('framework');
    const origin = getAttr('mintOrigin');
    if (framework) traitsDiv.innerHTML += '<span class="trait-tag">' + framework + '</span>';
    if (origin) traitsDiv.innerHTML += '<span class="trait-tag">' + origin + '</span>';
    attrs.filter(a => a.trait_type.endsWith('-verified')).forEach(a => {
      traitsDiv.innerHTML += '<span class="trait-tag" style="background:rgba(110,236,216,0.12);border-color:rgba(110,236,216,0.25);color:var(--mint)">✓ ' + a.trait_type + '</span>';
    });

    // Populate form fields
    document.getElementById('fieldName').value = meta.name || '';
    document.getElementById('fieldFramework').value = framework || '';
    document.getElementById('fieldVersion').value = getAttr('version') || '';
    document.getElementById('fieldPersonality').value = (getAttr('personality') || getAttr('quirks') || '');
    document.getElementById('fieldValues').value = (getAttr('values') || getAttr('communication style') || '');
    document.getElementById('fieldOrigin').value = getAttr('origin') || '';
    document.getElementById('fieldMission').value = getAttr('mission') || '';
    document.getElementById('fieldLore').value = getAttr('lore') || '';
    document.getElementById('fieldTwitter').value = getAttr('twitter') || '';
    document.getElementById('fieldWebsite').value = getAttr('website') || '';
    document.getElementById('fieldGithub').value = getAttr('github') || '';

    document.getElementById('agentInfo').style.display = 'block';
    showStatus('Loaded ' + meta.name + ' (#' + tokenId + ')', 'success');
  } catch (e) {
    showStatus('Error: ' + e.message, 'error');
  }
}

async function saveAgent() {
  if (currentTokenId === null) return;

  const btn = document.getElementById('saveBtn');
  btn.disabled = true;
  btn.textContent = 'Connecting wallet...';

  // Check for wallet
  if (!window.ethereum) {
    showStatus('No wallet found. Install MetaMask, Coinbase Wallet, or Phantom.', 'error');
    btn.disabled = false; btn.textContent = 'Save Changes';
    return;
  }

  try {
    // Request wallet connection
    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
    const account = accounts[0];

    // Build the signature message
    const timestamp = Date.now();
    const message = 'Helixa: Update agent #' + currentTokenId + ' at ' + timestamp;

    btn.textContent = 'Sign message in wallet...';
    showStatus('Please sign the message in your wallet to verify ownership.', 'info');

    // Request signature
    const signature = await window.ethereum.request({
      method: 'personal_sign',
      params: [message, account]
    });

    btn.textContent = 'Saving onchain...';
    showStatus('Submitting update...', 'info');

    const body = {
      signature,
      message,
      personality: {
        quirks: document.getElementById('fieldPersonality').value.trim(),
        values: document.getElementById('fieldValues').value.trim(),
      },
      narrative: {
        origin: document.getElementById('fieldOrigin').value.trim() || undefined,
        mission: document.getElementById('fieldMission').value.trim() || undefined,
        lore: document.getElementById('fieldLore').value.trim() || undefined,
      },
      social: {
        twitter: document.getElementById('fieldTwitter').value.trim() || undefined,
        website: document.getElementById('fieldWebsite').value.trim() || undefined,
        github: document.getElementById('fieldGithub').value.trim() || undefined,
      }
    };

    // Remove empty objects
    if (!body.narrative.origin && !body.narrative.mission && !body.narrative.lore) delete body.narrative;
    if (!body.social.twitter && !body.social.website && !body.social.github) delete body.social;
    if (!body.personality.quirks && !body.personality.values) delete body.personality;

    const resp = await fetch(API + '/agent/' + currentTokenId + '/human-update', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });

    if (resp.ok) {
      const data = await resp.json();
      showStatus('Agent updated! Fields: ' + (data.updated || []).join(', '), 'success');
    } else {
      const err = await resp.json().catch(() => ({}));
      showStatus('Update failed: ' + (err.error || resp.statusText), 'error');
    }
  } catch (e) {
    if (e.code === 4001) {
      showStatus('Signature rejected by user.', 'error');
    } else {
      showStatus('Error: ' + e.message, 'error');
    }
  }

  btn.disabled = false;
  btn.textContent = 'Save Changes';
}

// Auto-load from URL params
const params = new URLSearchParams(window.location.search);
const idParam = params.get('id') || params.get('token');
if (idParam) {
  document.getElementById('lookupInput').value = idParam;
  lookupAgent();
}
</script>
</body>
</html>
